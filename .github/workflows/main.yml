name: Build iOS (Device) - Unsigned

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      configuration:
        description: 'Build configuration'
        required: false
        default: 'Release'
        type: choice
        options: [Debug, Release]

env:
  XCODE_VERSION: '26.0'
  IOS_DEPLOYMENT_TARGET: '16.0'

jobs:
  build-ios-device:
    name: Build for iOS Device (Unsigned)
    runs-on: macos-26

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Xcode 26
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}

    - name: Install Nix
      uses: cachix/install-nix-action@v25
      with:
        extra_nix_config: |
          experimental-features = nix-command flakes
          accept-flake-config = true

    - name: Install nix-prefetch tools
      run: |
        nix profile install \
          nixpkgs#nix-prefetch-url \
          nixpkgs#nix-prefetch-github

    # ============================
    # Auto-fix Nix hashes (BASE32 ONLY)
    # ============================
    - name: Auto-fetch and fix Nix dependency hashes (safe)
      run: |
        set -e

        fetch_url_hash() {
          nix-prefetch-url "$1" | tail -1 | tr -d '\n'
        }

        fetch_github_hash() {
          nix-prefetch-github "$1" "$2" --rev "$3" \
            | grep -o 'sha256 = "[^"]*"' \
            | sed 's/sha256 = "\(.*\)"/\1/'
        }

        update_hash() {
          local file="$1"
          local hash="$2"

          sed -i '' \
            "s|sha256[[:space:]]*=[[:space:]]*\"[^\"]*\"|sha256 = \"$hash\"|g" \
            "$file"
        }

        for f in dependencies/*.nix; do
          [ -f "$f" ] || continue

          if grep -q fetchurl "$f"; then
            url=$(sed -n 's/.*url[[:space:]]*=[[:space:]]*"\([^"]*\)".*/\1/p' "$f" | head -1)
            [ -n "$url" ] || continue
            hash=$(fetch_url_hash "$url")
            update_hash "$f" "$hash"
            echo "✓ fixed $f (fetchurl)"

          elif grep -q fetchFromGitHub "$f"; then
            owner=$(sed -n 's/.*owner *= *"\([^"]*\)".*/\1/p' "$f" | head -1)
            repo=$(sed -n 's/.*repo *= *"\([^"]*\)".*/\1/p' "$f" | head -1)
            rev=$(sed -n 's/.*rev *= *"\([^"]*\)".*/\1/p' "$f" | head -1)
            [ -n "$owner" ] && [ -n "$repo" ] && [ -n "$rev" ] || continue
            hash=$(fetch_github_hash "$owner" "$repo" "$rev")
            update_hash "$f" "$hash"
            echo "✓ fixed $f (github)"
          fi
        done

        echo "---- diff ----"
        git diff dependencies || true

    # ============================
    # Build deps with Nix
    # ============================
    - name: Build iOS dependencies via Nix
      run: |
        set -e
        nix build \
          .#openssl-ios \
          .#zsign-ios \
          .#libplist-ios \
          .#libimobiledevice-glue-ios \
          .#libusbmuxd-ios \
          .#libimobiledevice-standalone-ios \
          .#em-proxy \
          .#minimuxer-ios \
          .#altsign \
          .#roxas \
          --print-build-logs

    # ============================
    # XcodeGen
    # ============================
    - name: Install XcodeGen
      run: brew install xcodegen

    - name: Generate Xcode project
      run: |
        xcodegen generate
        xcodebuild -project HIAHDesktop.xcodeproj -list

    # ============================
    # Build unsigned xcarchive
    # ============================
    - name: Build HIAHDesktop (unsigned)
      env:
        CONFIGURATION: ${{ github.event.inputs.configuration || 'Release' }}
      run: |
        set -o pipefail
        xcodebuild \
          -project HIAHDesktop.xcodeproj \
          -scheme HIAHDesktop \
          -sdk iphoneos \
          -configuration "$CONFIGURATION" \
          -archivePath build/HIAHDesktop.xcarchive \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ENABLE_BITCODE=NO \
          archive | tee build.log

    # ============================
    # Upload
    # ============================
    - uses: actions/upload-artifact@v4
      with:
        name: HIAHDesktop-xcarchive
        path: build/HIAHDesktop.xcarchive

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-log
        path: build.log        echo "*Signing: Unsigned (CODE_SIGN_IDENTITY=\"\")*" >> $GITHUB_STEP_SUMMARY
