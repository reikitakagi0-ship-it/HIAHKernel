name: Build HIAHKernel (iOS, Nix, Xcode 26)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-26

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
      MD_APPLE_SDK_ROOT: /Applications/Xcode_26.0.1.app
      NIX_CONFIG: |
        experimental-features = nix-command flakes
        substituters =
        trusted-substituters =

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Ensure Xcode 26
      # ------------------------------------------------------------
      - name: Select Xcode 26
        run: |
          sudo xcode-select -s /Applications/Xcode_26.0.1.app
          xcodebuild -version

      # ------------------------------------------------------------
      # 3. Install Nix (Determinate)
      # ------------------------------------------------------------
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12

      - name: Enable flakes
        run: |
          nix --version
          nix config show

      # ------------------------------------------------------------
      # 4. Auto-fix all Nix dependency hashes (SRI â†’ base32)
      # ------------------------------------------------------------
      - name: Fix Nix dependency hashes
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”§ Auto-fetching and fixing all Nix dependency hashes..."
          echo "Scanning dependencies/ for Nix files..."

          for f in dependencies/*.nix; do
            if grep -q "fetchFromGitHub" "$f"; then
              echo "Processing $(basename "$f") (fetchFromGitHub)"

              owner=$(grep -E 'owner\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              repo=$(grep -E 'repo\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              rev=$(grep -E 'rev\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')

              url="https://github.com/${owner}/${repo}/archive/${rev}.tar.gz"
              echo "  â†’ $url"

              sri=$(nix-prefetch-url --option substitute false "$url")
              hash=$(nix hash to-base32 "$sri")

              echo "  âœ“ sha256 = $hash"

              sed -i '' -E \
                "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
                "$f"

            elif grep -q "fetchurl" "$f"; then
              echo "Processing $(basename "$f") (fetchurl)"

              url=$(grep -E 'url\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              echo "  â†’ $url"

              sri=$(nix-prefetch-url --option substitute false "$url")
              hash=$(nix hash to-base32 "$sri")

              echo "  âœ“ sha256 = $hash"

              sed -i '' -E \
                "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
                "$f"
            else
              echo "Skipping $(basename "$f") (no fetchurl / fetchFromGitHub)"
            fi
          done

      # ------------------------------------------------------------
      # 5. Build all iOS dependencies (NO upload, NO IPA)
      # ------------------------------------------------------------
      - name: Build iOS dependencies
        shell: bash
        run: |
          set -e

          echo "ðŸ“¦ Building all dependencies for iOS Device..."

          nix build \
            .#openssl-ios \
            .#libplist-ios \
            .#libimobiledevice-glue-ios \
            .#libusbmuxd-ios \
            .#libimobiledevice-ios \
            .#zsign-ios

      # ------------------------------------------------------------
      # 6. Upload Nix build results (artifacts only)
      # ------------------------------------------------------------
      - name: Collect build outputs
        run: |
          mkdir -p artifacts
          cp -R result* artifacts/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nix-ios-build-results
          path: artifacts