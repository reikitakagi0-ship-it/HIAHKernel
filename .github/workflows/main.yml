name: Build HIAHKernel (iOS, Xcode 26, Nix)

on:
  push:
    branches: [ main ]

jobs:
  build-ios:
    runs-on: macos-26

    env:
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer
      MD_APPLE_SDK_ROOT: /Applications/Xcode_26.0.1.app
      NIX_CONFIG: |
        experimental-features = nix-command flakes
        substituters =
        trusted-substituters =
      DETERMINATE_NIX_KVM: 0

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Select Xcode 26
      # ------------------------------------------------------------
      - name: Select Xcode 26
        run: |
          sudo xcode-select -s /Applications/Xcode_26.0.1.app
          xcodebuild -version

      # ------------------------------------------------------------
      # 3. Install Nix (Determinate Systems)
      # ------------------------------------------------------------
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12
        with:
          extra-conf: |
            experimental-features = nix-command flakes

      # ------------------------------------------------------------
      # 4. Auto-fix sha256 for all Nix dependencies
      # ------------------------------------------------------------
      - name: Auto-fix Nix dependency hashes
        shell: bash
        run: |
          set -euo pipefail

          echo "ðŸ”§ Auto-fetching and fixing all Nix dependency hashes..."
          echo "Scanning dependencies/ for Nix files..."

          for f in dependencies/*.nix; do
            if grep -q "fetchFromGitHub" "$f"; then
              echo "Processing $(basename "$f") (fetchFromGitHub)"

              owner=$(grep -E 'owner\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              repo=$(grep -E 'repo\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              rev=$(grep -E 'rev\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')

              url="https://github.com/${owner}/${repo}/archive/${rev}.tar.gz"
              echo "  â†’ $url"

              # IMPORTANT:
              # nix-prefetch-url on macOS returns nix-base32 already
              hash=$(nix-prefetch-url --option substitute false "$url")

              echo "  âœ“ sha256 = $hash"

              sed -i '' -E \
                "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
                "$f"

            elif grep -q "fetchurl" "$f"; then
              echo "Processing $(basename "$f") (fetchurl)"

              url=$(grep -E 'url\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              echo "  â†’ $url"

              hash=$(nix-prefetch-url --option substitute false "$url")

              echo "  âœ“ sha256 = $hash"

              sed -i '' -E \
                "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
                "$f"
            else
              echo "Skipping $(basename "$f") (no fetchurl / fetchFromGitHub)"
            fi
          done

      # ------------------------------------------------------------
      # 5. Build all iOS dependencies via Nix
      # ------------------------------------------------------------
      - name: Build iOS dependencies
        shell: bash
        run: |
          set -e

          echo "ðŸ“¦ Building all dependencies for iOS Device..."

          nix build \
            .#openssl-ios \
            .#libplist-ios \
            .#libimobiledevice-glue-ios \
            .#libusbmuxd-ios \
            .#libimobiledevice-ios \
            .#zsign-ios

      # ------------------------------------------------------------
      # 6. Build Xcode archive (unsigned, no IPA)
      # ------------------------------------------------------------
      - name: Build xcarchive (unsigned)
        shell: bash
        run: |
          set -e

          xcodebuild \
            -scheme HIAHDesktop \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/HIAHKernel-iOS.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            archive

      # ------------------------------------------------------------
      # 7. Upload xcarchive
      # ------------------------------------------------------------
      - name: Upload xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: HIAHKernel-iOS-xcarchive
          path: build/HIAHKernel-iOS.xcarchive