name: Build iOS (Nix + Xcode 26)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-ios:
    runs-on: macos-26

    env:
      NIX_REMOTE: https://cache.nixos.org
      DEVELOPER_DIR: /Applications/Xcode_26.0.1.app/Contents/Developer

    steps:
      # ------------------------------------------------------------
      # 1. Checkout
      # ------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------------
      # 2. Setup Xcode 26
      # ------------------------------------------------------------
      - name: Setup Xcode 26
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.0"

      - name: Verify Xcode version
        run: |
          xcodebuild -version
          swift --version

      # ------------------------------------------------------------
      # 3. Install Nix
      # ------------------------------------------------------------
      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@v12
        with:
          nix_path: nixpkgs=channel:nixos-unstable

      - name: Enable Nix experimental features
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      # ------------------------------------------------------------
      # 4. Auto-fetch & fix Nix dependency hashes
      #    ÔºàYAMLÂÆâÂÖ® / BSD sedÂØæÂøú / base32„ÅÆ„ÅøÔºâ
      # ------------------------------------------------------------
      - name: Auto-fetch and fix all Nix dependency hashes
        shell: bash
        run: |
          set -euo pipefail

          echo "üîß Auto-fetching and fixing all Nix dependency hashes..."
          echo "Scanning dependencies/ for Nix files..."

          for f in dependencies/*.nix; do
            if grep -q "fetchFromGitHub" "$f"; then
              echo "Processing $(basename "$f") (fetchFromGitHub)"

              owner=$(grep -E 'owner\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              repo=$(grep -E 'repo\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              rev=$(grep -E 'rev\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')

              url="https://github.com/${owner}/${repo}/archive/${rev}.tar.gz"
              echo "  ‚Üí $url"

              hash=$(nix-prefetch-url "$url")
              echo "  ‚úì hash = $hash"

              sed -i '' -E \
                "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
                "$f"

            elif grep -q "fetchurl" "$f"; then
              echo "Processing $(basename "$f") (fetchurl)"

              url=$(grep -E 'url\s*=' "$f" | head -n1 | sed 's/.*"\(.*\)".*/\1/')
              echo "  ‚Üí $url"

              hash=$(nix-prefetch-url "$url")
              echo "  ‚úì hash = $hash"

              sed -i '' -E \
                "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
                "$f"
            else
              echo "Skipping $(basename "$f") (no fetchurl / fetchFromGitHub)"
            fi
          done

      # ------------------------------------------------------------
      # 5. Build all dependencies via Nix (iOS Device)
      # ------------------------------------------------------------
      - name: Build all dependencies for iOS Device
        run: |
          set -e
          echo "üì¶ Building all dependencies for iOS Device..."
          nix build \
            .#openssl-ios \
            .#libplist-ios \
            .#libimobiledevice-glue-ios \
            .#libusbmuxd-ios \
            .#libimobiledevice-ios \
            .#zsign-ios

      # ------------------------------------------------------------
      # 6. Install XcodeGen
      # ------------------------------------------------------------
      - name: Install XcodeGen
        run: |
          nix profile install nixpkgs#xcodegen
          xcodegen --version

      # ------------------------------------------------------------
      # 7. Generate Xcode project
      # ------------------------------------------------------------
      - name: Generate Xcode project
        run: |
          xcodegen generate

      # ------------------------------------------------------------
      # 8. Build iOS Device (unsigned xcarchive)
      # ------------------------------------------------------------
      - name: Build HIAHDesktop (unsigned)
        run: |
          set -e
          xcodebuild \
            -project HIAHDesktop.xcodeproj \
            -scheme HIAHDesktop \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/HIAHDesktop.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive

      # ------------------------------------------------------------
      # 9. Upload artifacts
      # ------------------------------------------------------------
      - name: Upload xcarchive
        uses: actions/upload-artifact@v4
        with:
          name: HIAHDesktop-xcarchive
          path: build/HIAHDesktop.xcarchive

      - name: Upload build logs
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ~/Library/Logs/DiagnosticReports