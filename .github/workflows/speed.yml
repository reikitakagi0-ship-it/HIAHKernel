name: Build iOS deps with auto-fix hashes

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-26

    env:
      NIX_CONFIG: |
        experimental-features = nix-command flakes
        max-jobs = auto
        cores = 0

    steps:
      # 1. Checkout
      - uses: actions/checkout@v4

      # 2. Setup Xcode 26
      - name: Setup Xcode 26
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.0"

      # 3. Install Nix
      - name: Install Nix
        run: |
          curl -L https://nixos.org/nix/install | sh -s -- --daemon
          . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh

      # 4. Auto-fix all dependency hashesÔºà‰∏¶ÂàóÂåñÔºâ
      - name: Auto-fix Nix dependency hashes
        run: |
          set -euo pipefail
          echo "üîß Auto-fixing dependency hashes..."

          export NIX_CONFIG

          fix_file() {
            f="$1"
            echo "‚ñ∂ $f"

            if grep -q fetchFromGitHub "$f"; then
              owner=$(grep -E 'owner\s*=' "$f" | head -n1 | sed -E 's/.*"(.*)".*/\1/')
              repo=$(grep -E 'repo\s*=' "$f" | head -n1 | sed -E 's/.*"(.*)".*/\1/')
              rev=$(grep -E 'rev\s*=' "$f" | head -n1 | sed -E 's/.*"(.*)".*/\1/')
              url="https://github.com/${owner}/${repo}/archive/${rev}.tar.gz"

            elif grep -q fetchurl "$f"; then
              url=$(grep -E 'url\s*=' "$f" | head -n1 | sed -E 's/.*"(.*)".*/\1/')

            else
              echo "  ‚è≠ skip"
              return
            fi

            hash=$(nix-prefetch-url --type sha256 "$url" | tail -n1)

            sed -i '' -E \
              "s|sha256\s*=\s*\"[^\"]*\"|sha256 = \"${hash}\"|g" \
              "$f"
          }

          export -f fix_file
          ls dependencies/*.nix | xargs -n1 -P$(sysctl -n hw.ncpu) bash -c 'fix_file "$@"' _

      # 5. Commit updated hashes
      - name: Commit updated hashes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add dependencies/*.nix
          git commit -m "auto: update nix dependency hashes" || echo "No changes"
          git push

      # 6. Build all iOS dependenciesÔºà„Åæ„Å®„ÇÅ & ‰∏¶ÂàóÔºâ
      - name: Build all iOS dependencies
        run: |
          set -e
          echo "üì¶ Building iOS dependencies..."

          nix build \
            .#openssl-ios \
            .#libplist-ios \
            .#libimobiledevice-glue-ios \
            .#libusbmuxd-ios \
            .#libimobiledevice-ios \
            .#zsign-ios \
            --out-link result \
            --print-build-logs

          # ÊàêÊûúÁâ©„Çí zip „Å´„Åæ„Å®„ÇÅ„Çã
          mkdir -p artifacts
          cp -R result artifacts/
          cd artifacts
          zip -r ios-deps.zip result

      # 7. Upload artifacts
      - name: Upload built iOS dependencies
        uses: actions/upload-artifact@v3
        with:
          name: ios-deps
          path: artifacts/ios-deps.zip